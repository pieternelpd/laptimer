<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Cycling Lap Timer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #222;
            color: white;
            transition: background-color 0.3s;
        }
        
        body.no-scroll {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #333;
            border-radius: 8px;
        }
        
        .section-title {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .timer-display {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .time-box {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #444;
            border-radius: 5px;
        }
        
        .time-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .time-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            flex: 1;
            padding: 33px 15px;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .btn-start { background-color: #4CAF50; color: white; }
        .btn-stop { background-color: #f44336; color: white; }
        .btn-reset { background-color: #607D8B; color: white; }
        
        .btn-back {
            background-color: #607D8B;
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 2;
        }
        
        .settings-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .input-label {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .input-field {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
        }
        
        .half-width { width: 50%; }
        
        .toggle-container {
            display: flex;
            width: 100%;
            border-radius: 5px;
            overflow: hidden;
            background-color: #333;
            border: 1px solid #555;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #333;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .toggle-btn:first-child {
            border-right: 1px solid #555;
        }
        
        .toggle-active {
            background-color: #2196F3;
            color: white;
            font-weight: bold;
        }
        
        .analysis-grid {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .analysis-item {
            flex: 0 1 auto;
            background-color: #444;
            padding: 8px 16px;
            border-radius: 5px;
            text-align: center;
            min-width: 0;
            display: inline-flex;
            align-items: center;
        }
        
        .analysis-label {
            font-size: 0.9rem;
            margin-right: 5px;
            opacity: 0.8;
        }
        
        .analysis-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .lap-chart-container {
            width: 100%;
            height: 200px;
            background-color: #444;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .history {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th, 
        .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        
        .history-table .col-vs-prev,
        .history-table .col-vs-target {
            display: none;
        }
        .history-table.show-vs-prev .col-vs-prev { display: table-cell; }
        .history-table.show-vs-target .col-vs-target { display: table-cell; }
        
        .history-toggles {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .history-toggle {
            padding: 6px 12px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: #aaa;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .history-toggle.active {
            background-color: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        .fullscreen-lap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .lap-large {
            font-size: 35rem;
            font-weight: 900;
            line-height: 1;
            text-shadow: 
                -6px -6px 0 #000,
                6px -6px 0 #000,
                -6px 6px 0 #000,
                6px 6px 0 #000,
                0 -8px 14px rgba(0, 0, 0, 0.7),
                0 8px 14px rgba(0, 0, 0, 0.7);
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            display: none;
        }
        
        /* Copy fallback overlay (shown only if clipboard API and execCommand both fail) */
        .copy-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .copy-overlay.visible { display: flex; }
        .copy-modal {
            width: 90%; max-width: 500px;
            background-color: #333;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .copy-modal h3 {
            color: white; margin: 0 0 15px;
            font-size: 18px; text-align: center;
        }
        .copy-modal .instructions {
            color: white; margin: 0 0 15px;
            font-size: 16px; text-align: center;
            background-color: #444;
            padding: 10px; border-radius: 5px;
        }
        .copy-modal textarea {
            width: 100%; height: 150px; padding: 10px;
            background-color: #222; color: white;
            border: 1px solid #555; border-radius: 5px;
            font-size: 16px; margin-bottom: 15px; resize: vertical;
        }
        .copy-modal .btn-close {
            width: 100%; padding: 12px;
            background-color: #4CAF50; color: white;
            border: none; border-radius: 5px;
            font-size: 16px; font-weight: bold; cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .time-value { font-size: 1.5rem; }
            .btn { padding: 27px 8px; font-size: 1rem; }
            .lap-large { font-size: 28rem; }
            .analysis-value { font-size: 1rem; }
        }
        
        @media (max-width: 900px) and (orientation: landscape) {
            .container { max-width: 100%; padding: 10px; }
            .section { margin-bottom: 10px; padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Timer Section -->
        <div class="section" id="timerSection">
            <div class="timer-display">
                <div class="time-box">
                    <div class="time-label">Laps Left</div>
                    <div class="time-value" id="lapsLeft">10</div>
                </div>
                <div class="time-box">
                    <div class="time-label">Current Lap</div>
                    <div class="time-value" id="currentLap">00:00.0</div>
                </div>
                <div class="time-box">
                    <div class="time-label">Total Time</div>
                    <div class="time-value" id="totalTime">00:00.0</div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-start" id="btnStartLap">Start/Lap</button>
                <button class="btn btn-stop" id="btnStop">Stop</button>
                <button class="btn btn-reset" id="btnReset">Reset</button>
            </div>
        </div>
        
        <!-- Settings Section -->
        <div class="section" id="settingsSection">
            <h2 class="section-title">Settings</h2>
            <div class="settings-row">
                <div class="input-group">
                    <label class="input-label" for="targetTime">Target Time (s)</label>
                    <input type="number" class="input-field half-width" id="targetTime" value="20" min="0" step="0.1">
                </div>
                <div class="input-group">
                    <label class="input-label" for="targetLaps">Number of Laps</label>
                    <input type="number" class="input-field half-width" id="targetLaps" value="10" min="1" step="1">
                </div>
            </div>
            <div class="settings-row">
                <div class="input-group">
                    <label class="input-label">Fullscreen Background</label>
                    <div class="toggle-container">
                        <button type="button" id="bgWhiteBtn" class="toggle-btn toggle-active">White</button>
                        <button type="button" id="bgColorBtn" class="toggle-btn">Coloured</button>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">Fullscreen Display</label>
                    <div class="toggle-container">
                        <button type="button" id="lapTimeBtn" class="toggle-btn toggle-active">Lap Time</button>
                        <button type="button" id="diffBtn" class="toggle-btn">Diff from Target</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Section -->
        <div class="section" id="analysisSection">
            <h2 class="section-title">Performance Analysis</h2>
            <div class="analysis-grid">
                <div class="analysis-item">
                    <span class="analysis-label">Best:</span>
                    <span class="analysis-value" id="bestLap">--</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Diff:</span>
                    <span class="analysis-value" id="targetDiff">--</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Avg:</span>
                    <span class="analysis-value" id="avgLap">--</span>
                </div>
            </div>
            <div class="lap-chart-container">
                <canvas id="lapChart"></canvas>
            </div>
        </div>
        
        <!-- Lap History Section -->
        <div class="section" id="historySection">
            <h2 class="section-title">Lap History <button id="copyHistory" class="btn" style="font-size: 0.9rem; padding: 8px 15px; float: right;">Copy</button></h2>
            <div class="history-toggles">
                <button type="button" id="toggleVsPrev" class="history-toggle">vs Prev</button>
                <button type="button" id="toggleVsTarget" class="history-toggle">vs Target</button>
            </div>
            <div class="history">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Lap</th>
                            <th>Lap Time</th>
                            <th>Total Time</th>
                            <th class="col-vs-prev">vs Prev</th>
                            <th class="col-vs-target">vs Target</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Fullscreen lap display -->
    <div class="fullscreen-lap" id="fullscreenLap">
        <button class="btn btn-back" id="btnBack">Back</button>
        <div class="lap-large" id="lapLarge">0</div>
    </div>
    
    <!-- Toast notification (reusable, hidden by default) -->
    <div class="toast" id="toast"></div>
    
    <!-- Copy fallback overlay (only shown if clipboard APIs fail) -->
    <div class="copy-overlay" id="copyOverlay">
        <div class="copy-modal">
            <h3>Copy Lap Data</h3>
            <p class="instructions"><b>Select all text below</b>, then tap <b>Copy</b></p>
            <textarea id="copyTextarea" readonly></textarea>
            <button class="btn-close" id="copyClose">Close</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ===== DOM ELEMENTS =====
            const $ = id => document.getElementById(id);
            
            const totalTimeEl     = $('totalTime');
            const currentLapEl    = $('currentLap');
            const btnStartLap     = $('btnStartLap');
            const btnStop         = $('btnStop');
            const btnReset        = $('btnReset');
            const historyBody     = $('historyBody');
            const fullscreenLap   = $('fullscreenLap');
            const lapLarge        = $('lapLarge');
            const btnBack         = $('btnBack');
            const targetTimeInput = $('targetTime');
            const targetLapsInput = $('targetLaps');
            const lapsLeftEl      = $('lapsLeft');
            const bestLapEl       = $('bestLap');
            const avgLapEl        = $('avgLap');
            const targetDiffEl    = $('targetDiff');
            const lapChartEl      = $('lapChart');
            const lapTimeBtn      = $('lapTimeBtn');
            const diffBtn         = $('diffBtn');
            const bgWhiteBtn      = $('bgWhiteBtn');
            const bgColorBtn      = $('bgColorBtn');
            const toastEl         = $('toast');
            const copyOverlay     = $('copyOverlay');
            const copyTextarea    = $('copyTextarea');
            const copyCloseBtn    = $('copyClose');
            const copyHistoryBtn  = $('copyHistory');
            const historyTable    = $('historyTable');
            const toggleVsPrev    = $('toggleVsPrev');
            const toggleVsTarget  = $('toggleVsTarget');
            
            // ===== STATE =====
            let startTime = 0;
            let lapStartTime = 0;
            let totalTime = 0;
            let isRunning = false;
            let timerInterval = null;
            let lapNumber = 0;
            let prevLapTime = 0;
            let lastLapTime = 0;
            let lapsRemaining = parseInt(targetLapsInput.value, 10);
            let lastStartLapTime = 0;
            const DEBOUNCE_MS = 1000;
            let lapTimes = [];
            let showDiff = false;
            let useColorBg = false;
            
            // ===== UTILITIES =====
            
            /** Get target time in milliseconds from the input field */
            function getTargetMs() {
                return parseFloat(targetTimeInput.value) * 1000;
            }
            
            /** Show a brief toast notification */
            function showToast(message, isSuccess) {
                toastEl.textContent = message;
                toastEl.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
                toastEl.style.display = 'block';
                setTimeout(() => { toastEl.style.display = 'none'; }, 1500);
            }
            
            /**
             * Format time for display.
             * @param {number} timeInMs - Time in milliseconds
             * @param {number} decimals - 1 for live display, 2 for history table
             */
            function formatTime(timeInMs, decimals = 2) {
                const minutes = Math.floor(timeInMs / 60000);
                const seconds = Math.floor((timeInMs % 60000) / 1000);
                const base = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (decimals === 1) {
                    return `${base}.${Math.floor((timeInMs % 1000) / 100)}`;
                }
                
                const tenths = Math.floor((timeInMs % 1000) / 100);
                const hundredths = Math.floor((timeInMs % 100) / 10);
                
                return hundredths === 0
                    ? `${base}.${tenths}`
                    : `${base}.${String(tenths * 10 + hundredths).padStart(2, '0')}`;
            }
            
            /** Format for the large fullscreen display (last digit of seconds + 1 decimal) */
            function formatLapDisplay(timeInMs) {
                const totalSeconds = timeInMs / 1000;
                return totalSeconds.toFixed(1);
            }
            
            // ===== UNIFIED BUTTON BINDING =====
            // Handles both click and touchstart, preventing double-fires on mobile
            
            function bindButton(el, handler) {
                if (!el) return;
                el.addEventListener('click', handler);
                el.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handler();
                }, { passive: false });
            }
            
            // ===== SCROLL CONTROL =====
            
            function preventTouchMove(e) {
                let el = e.target;
                while (el) {
                    if (el.classList && el.classList.contains('history')) return;
                    el = el.parentElement;
                }
                e.preventDefault();
            }
            
            function disableScroll() {
                document.body.classList.add('no-scroll');
                document.addEventListener('touchmove', preventTouchMove, { passive: false });
            }
            
            function enableScroll() {
                document.body.classList.remove('no-scroll');
                document.removeEventListener('touchmove', preventTouchMove);
            }
            
            // ===== DISPLAY UPDATE =====
            
            function updateDisplay() {
                const now = Date.now();
                totalTimeEl.textContent = formatTime(
                    isRunning ? (now - startTime + totalTime) : totalTime, 1
                );
                currentLapEl.textContent = formatTime(
                    isRunning ? (now - lapStartTime) : lastLapTime, 1
                );
            }
            
            // ===== CORE HANDLERS =====
            
            function handleStartLap() {
                const now = Date.now();
                
                // Debounce check
                const elapsed = now - lastStartLapTime;
                if (elapsed < DEBOUNCE_MS) {
                    btnStartLap.style.backgroundColor = '#888';
                    showToast(`Please wait ${((DEBOUNCE_MS - elapsed) / 1000).toFixed(1)} sec`, false);
                    setTimeout(() => { btnStartLap.style.backgroundColor = ''; }, 200);
                    return;
                }
                lastStartLapTime = now;
                
                if (!isRunning) {
                    // Start timer
                    isRunning = true;
                    startTime = now;
                    lapStartTime = now;
                    btnStop.disabled = false;
                    
                    lapsRemaining = parseInt(targetLapsInput.value, 10);
                    if (lapsRemaining > 0) lapsRemaining--;
                    lapsLeftEl.textContent = lapsRemaining;
                    
                    disableScroll();
                    timerInterval = setInterval(updateDisplay, 100);
                    btnStartLap.textContent = 'Lap';
                } else {
                    // Record lap
                    const lapTime = now - lapStartTime;
                    
                    addLapToHistory(lapTime);
                    
                    if (lapsRemaining > 0) {
                        lapsRemaining--;
                        lapsLeftEl.textContent = lapsRemaining;
                        if (lapsRemaining === 0) {
                            lapsLeftEl.style.color = '#4CAF50';
                            showToast('All laps completed!', true);
                        }
                    }
                    
                    lapStartTime = now;
                    prevLapTime = lapTime;
                    showFullscreenLap(lapTime);
                }
            }
            
            function handleStop() {
                if (!isRunning) return;
                
                const now = Date.now();
                const lapTime = now - lapStartTime;
                
                // Record final lap before stopping
                addLapToHistory(lapTime);
                
                if (lapsRemaining > 0) {
                    lapsRemaining--;
                    lapsLeftEl.textContent = lapsRemaining;
                    if (lapsRemaining === 0) {
                        lapsLeftEl.style.color = '#4CAF50';
                        showToast('All laps completed!', true);
                    }
                }
                
                prevLapTime = lapTime;
                
                isRunning = false;
                clearInterval(timerInterval);
                enableScroll();
                
                lastLapTime = lapTime;
                totalTime += (now - startTime);
                
                btnStartLap.textContent = 'Start/Lap';
                lastStartLapTime = 0;
                btnStop.disabled = true;
                
                showFullscreenLap(lapTime);
            }
            
            function handleReset() {
                isRunning = false;
                clearInterval(timerInterval);
                startTime = lapStartTime = totalTime = lapNumber = prevLapTime = lastLapTime = lastStartLapTime = 0;
                lapTimes = [];
                
                lapsRemaining = parseInt(targetLapsInput.value, 10);
                lapsLeftEl.textContent = lapsRemaining;
                lapsLeftEl.style.color = '';
                
                enableScroll();
                
                totalTimeEl.textContent = '00:00.0';
                currentLapEl.textContent = '00:00.0';
                historyBody.innerHTML = '';
                
                bestLapEl.textContent = avgLapEl.textContent = targetDiffEl.textContent = '--';
                btnStartLap.textContent = 'Start/Lap';
                
                if (window.lapChart && typeof window.lapChart.destroy === 'function') {
                    window.lapChart.destroy();
                }
                window.lapChart = null;
                btnStop.disabled = true;
            }
            
            function handleBack() {
                fullscreenLap.style.display = 'none';
            }
            
            // ===== LAP HISTORY =====
            
            function addLapToHistory(lapTime) {
                lapNumber++;
                const targetMs = getTargetMs();
                lapTimes.push(lapTime);
                
                const row = document.createElement('tr');
                
                // Helper to add a table cell
                const addCell = (text, color, className) => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    if (color) td.style.color = color;
                    if (className) td.className = className;
                    row.appendChild(td);
                };
                
                addCell(lapNumber);
                addCell(formatTime(lapTime));
                
                // Total time
                const calcTotal = isRunning ? totalTime + (Date.now() - startTime) : totalTime;
                addCell(formatTime(calcTotal));
                
                // vs Previous
                if (lapNumber > 1) {
                    const diff = lapTime - prevLapTime;
                    const sign = diff >= 0 ? '+' : '-';
                    addCell(`${sign}${formatTime(Math.abs(diff))}`, diff >= 0 ? '#f44336' : '#4CAF50', 'col-vs-prev');
                } else {
                    addCell('00:00.00', null, 'col-vs-prev');
                }
                
                // vs Target
                const diffTarget = lapTime - targetMs;
                const signTarget = diffTarget >= 0 ? '+' : '-';
                addCell(
                    `${signTarget}${formatTime(Math.abs(diffTarget))}`,
                    diffTarget >= 0 ? '#f44336' : '#4CAF50',
                    'col-vs-target'
                );
                
                historyBody.appendChild(row);
                lastLapTime = lapTime;
                updatePerformanceAnalysis();
            }
            
            // ===== FULLSCREEN LAP DISPLAY =====
            
            function showFullscreenLap(lapTime) {
                let safeTime = Number(lapTime);
                if (isNaN(safeTime) || safeTime <= 0) safeTime = 1000;
                
                const targetMs = getTargetMs();
                const isFaster = safeTime < targetMs;
                const performanceColor = isFaster ? '#4CAF50' : '#f44336';
                
                if (useColorBg) {
                    fullscreenLap.style.backgroundColor = performanceColor;
                } else {
                    fullscreenLap.style.backgroundColor = 'white';
                }
                lapLarge.style.color = 'black';
                lapLarge.style.textShadow = 'none';
                
                if (showDiff) {
                    const diffSeconds = (targetMs - safeTime) / 1000;
                    lapLarge.textContent = (diffSeconds >= 0 ? '+' : '') + diffSeconds.toFixed(1);
                } else {
                    lapLarge.textContent = formatLapDisplay(safeTime);
                }
                
                fullscreenLap.style.display = 'flex';
            }
            
            // ===== PERFORMANCE ANALYSIS =====
            
            function updatePerformanceAnalysis() {
                if (lapTimes.length === 0) return;
                
                const targetMs = getTargetMs();
                const bestLap = Math.min(...lapTimes);
                const totalLapTime = lapTimes.reduce((sum, t) => sum + t, 0);
                const avgLap = totalLapTime / lapTimes.length;
                const avgAbsDiff = lapTimes.reduce((sum, t) => sum + Math.abs(t - targetMs), 0) / lapTimes.length;
                
                bestLapEl.textContent = formatTime(bestLap);
                avgLapEl.textContent = formatTime(avgLap);
                targetDiffEl.textContent = formatTime(avgAbsDiff);
                
                updateLapChart();
            }
            
            // ===== LAP CHART =====
            
            function updateLapChart() {
                if (!lapChartEl || lapTimes.length === 0) return;
                
                const targetMs = getTargetMs();
                const labels = lapTimes.map((_, i) => `Lap ${i + 1}`);
                const lapSeconds = lapTimes.map(t => t / 1000);
                const targetSeconds = targetMs / 1000;
                
                const bgColors = lapTimes.map(t =>
                    t < targetMs ? 'rgba(76, 175, 80, 0.7)' : 'rgba(244, 67, 54, 0.7)'
                );
                
                if (window.lapChart && typeof window.lapChart.destroy === 'function') {
                    window.lapChart.destroy();
                }
                
                try {
                    window.lapChart = new Chart(lapChartEl.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [
                                {
                                    label: 'Lap Time (seconds)',
                                    data: lapSeconds,
                                    backgroundColor: bgColors,
                                    borderColor: bgColors.map(c => c.replace('0.7', '1')),
                                    borderWidth: 1
                                },
                                {
                                    type: 'line',
                                    label: 'Target',
                                    data: Array(lapTimes.length).fill(targetSeconds),
                                    borderColor: 'rgba(255, 255, 255, 0.7)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    min: Math.min(...lapSeconds) * 0.95,
                                    max: Math.max(...lapSeconds) * 1.05,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Chart creation error:', error);
                }
            }
            
            // ===== COPY TO CLIPBOARD =====
            
            function generateHistoryText() {
                const rows = historyBody.querySelectorAll('tr');
                if (rows.length === 0) return null;
                
                const showPrev = historyTable.classList.contains('show-vs-prev');
                const showTarget = historyTable.classList.contains('show-vs-target');
                
                let headers = ['Lap', 'Lap Time', 'Total Time'];
                if (showPrev) headers.push('vs Prev');
                if (showTarget) headers.push('vs Target');
                let text = headers.join('\t') + '\n';
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) {
                        const values = Array.from(cells)
                            .filter(c => {
                                if (c.classList.contains('col-vs-prev') && !showPrev) return false;
                                if (c.classList.contains('col-vs-target') && !showTarget) return false;
                                return true;
                            })
                            .map(c => c.textContent.trim());
                        text += values.join('\t') + '\n';
                    }
                });
                return text;
            }
            
            /**
             * Copy text using execCommand fallback.
             * Works on iOS Safari by using contentEditable + readOnly trick
             * and setSelectionRange instead of select().
             */
            function execCommandCopy(text) {
                const ta = document.createElement('textarea');
                ta.value = text;
                
                // iOS Safari needs the element to be on-screen and editable
                ta.contentEditable = true;
                ta.readOnly = true;            // prevents keyboard from opening on iOS
                ta.style.position = 'fixed';   // keep in viewport
                ta.style.top = '0';
                ta.style.left = '0';
                ta.style.width = '1px';
                ta.style.height = '1px';
                ta.style.padding = '0';
                ta.style.border = 'none';
                ta.style.outline = 'none';
                ta.style.opacity = '0';
                
                document.body.appendChild(ta);
                
                // iOS Safari requires setSelectionRange; select() alone can fail
                ta.focus();
                ta.setSelectionRange(0, ta.value.length);
                
                let success = false;
                try {
                    success = document.execCommand('copy');
                } catch (e) {
                    success = false;
                }
                
                document.body.removeChild(ta);
                return success;
            }
            
            /**
             * Primary copy handler — tries Clipboard API first, then execCommand,
             * then falls back to manual overlay as last resort.
             */
            function handleCopy() {
                const text = generateHistoryText();
                if (!text) {
                    showToast('No lap data to copy', false);
                    return;
                }
                
                // Method 1: Modern Clipboard API (Edge, Safari 13.4+, Chrome, Firefox)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(
                        () => showToast('Copied to clipboard!', true),
                        () => {
                            // Clipboard API rejected — try execCommand
                            if (execCommandCopy(text)) {
                                showToast('Copied to clipboard!', true);
                            } else {
                                showFallbackOverlay(text);
                            }
                        }
                    );
                    return;
                }
                
                // Method 2: execCommand fallback (older browsers / insecure context)
                if (execCommandCopy(text)) {
                    showToast('Copied to clipboard!', true);
                    return;
                }
                
                // Method 3: Manual select-and-copy overlay (absolute last resort)
                showFallbackOverlay(text);
            }
            
            function showFallbackOverlay(text) {
                copyTextarea.value = text;
                copyOverlay.classList.add('visible');
                setTimeout(() => { copyTextarea.focus(); copyTextarea.setSelectionRange(0, text.length); }, 100);
            }
            
            function hideCopyOverlay() {
                copyOverlay.classList.remove('visible');
            }
            
            // ===== TOGGLE DISPLAY MODE =====
            
            function handleLapTimeBtn() {
                showDiff = false;
                lapTimeBtn.classList.add('toggle-active');
                diffBtn.classList.remove('toggle-active');
            }
            
            function handleDiffBtn() {
                showDiff = true;
                diffBtn.classList.add('toggle-active');
                lapTimeBtn.classList.remove('toggle-active');
            }
            
            function handleBgWhite() {
                useColorBg = false;
                bgWhiteBtn.classList.add('toggle-active');
                bgColorBtn.classList.remove('toggle-active');
            }
            
            function handleBgColor() {
                useColorBg = true;
                bgColorBtn.classList.add('toggle-active');
                bgWhiteBtn.classList.remove('toggle-active');
            }
            
            function handleToggleVsPrev() {
                toggleVsPrev.classList.toggle('active');
                historyTable.classList.toggle('show-vs-prev');
            }
            
            function handleToggleVsTarget() {
                toggleVsTarget.classList.toggle('active');
                historyTable.classList.toggle('show-vs-target');
            }
            
            // ===== BIND ALL BUTTON EVENTS =====
            
            bindButton(btnStartLap, handleStartLap);
            bindButton(btnStop, handleStop);
            bindButton(btnReset, handleReset);
            bindButton(btnBack, handleBack);
            bindButton(lapTimeBtn, handleLapTimeBtn);
            bindButton(diffBtn, handleDiffBtn);
            bindButton(bgWhiteBtn, handleBgWhite);
            bindButton(bgColorBtn, handleBgColor);
            bindButton(toggleVsPrev, handleToggleVsPrev);
            bindButton(toggleVsTarget, handleToggleVsTarget);
            bindButton(copyHistoryBtn, handleCopy);
            bindButton(copyCloseBtn, hideCopyOverlay);
            
            // Close overlay when tapping outside modal
            copyOverlay.addEventListener('click', function(e) {
                if (e.target === copyOverlay) hideCopyOverlay();
            });
            
            // Update laps display when input changes
            targetLapsInput.addEventListener('change', function() {
                lapsRemaining = parseInt(targetLapsInput.value, 10);
                lapsLeftEl.textContent = lapsRemaining;
            });
            
            // Initialize display
            lapsLeftEl.textContent = targetLapsInput.value;
            
            // ===== MOBILE INPUT BLUR HANDLING =====
            
            let lastFocusedInput = null;
            
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('focus', function() { lastFocusedInput = this; });
                input.addEventListener('blur', function() {
                    setTimeout(() => {
                        if (document.activeElement !== input) lastFocusedInput = null;
                    }, 100);
                });
            });
            
            document.addEventListener('touchstart', function(e) {
                if (lastFocusedInput && e.target.tagName.toLowerCase() !== 'input' && !e.target.closest('input')) {
                    lastFocusedInput.blur();
                    lastFocusedInput = null;
                    if (e.target.tagName.toLowerCase() !== 'button' && !e.target.closest('button')) {
                        e.preventDefault();
                    }
                }
            }, { passive: false });
            
            $('timerSection').addEventListener('touchstart', function() {
                if (lastFocusedInput) {
                    lastFocusedInput.blur();
                    lastFocusedInput = null;
                }
            }, { passive: false });
        });
    </script>
</body>
</html>
