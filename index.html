<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Cycling Lap Timer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #222;
            color: white;
            transition: background-color 0.3s;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #333;
            border-radius: 8px;
        }
        
        .section-title {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .timer-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .time-box {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #444;
            border-radius: 5px;
            margin: 0 5px;
        }
        
        .time-box:first-child {
            margin-left: 0;
        }
        
        .time-box:last-child {
            margin-right: 0;
        }
        
        .time-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .time-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
        }
        
        .btn {
            flex: 1;
            margin: 0 5px;
            padding: 22px 15px; /* Increased height by 50% */
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .btn:first-child {
            margin-left: 0;
        }
        
        .btn:last-child {
            margin-right: 0;
        }
        
        .btn-start {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-stop {
            background-color: #f44336;
            color: white;
        }
        
        .btn-reset {
            background-color: #607D8B;
            color: white;
        }
        
        .btn-back {
            background-color: #607D8B;
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 2;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 5px;
        }
        
        .input-group:first-child {
            margin-left: 0;
        }
        
        .input-group:last-child {
            margin-right: 0;
        }
        
        .input-label {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .input-field {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
        }
        
        .half-width {
            width: 50%;
        }
        
        .toggle-container {
            display: flex;
            width: 100%;
            border-radius: 5px;
            overflow: hidden;
            background-color: #333;
            border: 1px solid #555;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #333;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .toggle-btn:first-child {
            border-right: 1px solid #555;
        }
        
        .toggle-active {
            background-color: #2196F3;
            color: white;
            font-weight: bold;
        }
        
        .analysis-grid {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .analysis-item {
            flex: 0 1 auto;
            background-color: #444;
            padding: 8px 16px;
            border-radius: 5px;
            text-align: center;
            min-width: 0;
            display: inline-flex;
            align-items: center;
        }
        
        .analysis-label {
            font-size: 0.9rem;
            margin-right: 5px;
            opacity: 0.8;
        }
        
        .analysis-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .lap-chart-container {
            width: 100%;
            height: 200px;
            background-color: #444;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .history {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th, 
        .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        
        .history-controls {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .fullscreen-lap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .lap-large {
            font-size: 25rem;
            font-weight: 900;
            line-height: 1;
            text-shadow: 
                -4px -4px 0 #000,
                4px -4px 0 #000,
                -4px 4px 0 #000,
                4px 4px 0 #000,
                0 -6px 10px rgba(0, 0, 0, 0.7),
                0 6px 10px rgba(0, 0, 0, 0.7);
        }
        
        body.no-scroll {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .time-value {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 18px 8px; /* Increased height by 50% */
                font-size: 1rem;
            }
            
            .lap-large {
                font-size: 20rem;
            }
            
            .analysis-value {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <div class="timer-display">
                <div class="time-box">
                    <div class="time-label">Current Lap</div>
                    <div class="time-value" id="currentLap">00:00.0</div>
                </div>
                <div class="time-box">
                    <div class="time-label">Total Time</div>
                    <div class="time-value" id="totalTime">00:00.0</div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-start" id="btnStartLap">Start/Lap</button>
                <button class="btn btn-stop" id="btnStop">Stop</button>
                <button class="btn btn-reset" id="btnReset">Reset</button>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">Settings</h2>
            <div class="settings-row">
                <div class="input-group">
                    <label class="input-label" for="targetTime">Target Time (s)</label>
                    <input type="number" class="input-field half-width" id="targetTime" value="20" min="0" step="0.1">
                </div>
                <div class="input-group">
                    <label class="input-label">Fullscreen Display</label>
                    <div class="toggle-container">
                        <button type="button" id="lapTimeBtn" class="toggle-btn toggle-active">Lap Time</button>
                        <button type="button" id="diffBtn" class="toggle-btn">Diff from Target</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">Performance Analysis</h2>
            <div class="analysis-grid">
                <div class="analysis-item">
                    <span class="analysis-label">Best:</span>
                    <span class="analysis-value" id="bestLap">--</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Diff:</span>
                    <span class="analysis-value" id="targetDiff">--</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Avg:</span>
                    <span class="analysis-value" id="avgLap">--</span>
                </div>
            </div>
            <div class="lap-chart-container">
                <canvas id="lapChart"></canvas>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">Lap History <button id="copyHistory" class="btn" style="font-size: 0.8rem; padding: 5px 10px; float: right;">Copy</button></h2>
            <div class="history">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Lap</th>
                            <th>Lap Time</th>
                            <th>Total Time</th>
                            <th>vs Prev</th>
                            <th>vs Target</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- History entries will go here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="fullscreen-lap" id="fullscreenLap">
        <button class="btn btn-back" id="btnBack">Back</button>
        <div class="lap-large" id="lapLarge">0</div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🚀 Track Cycling Lap Timer Initializing");
            
            // Universal toast notification function
            function showToast(message, isSuccess) {
                // Remove any existing toast
                const existingToast = document.getElementById('notification-toast');
                if (existingToast) {
                    document.body.removeChild(existingToast);
                }
                
                // Create new toast
                const toast = document.createElement('div');
                toast.id = 'notification-toast';
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
                toast.style.color = 'white';
                toast.style.padding = '10px 20px';
                toast.style.borderRadius = '5px';
                toast.style.zIndex = '1000';
                toast.style.textAlign = 'center';
                toast.style.boxShadow = '0 3px 6px rgba(0,0,0,0.2)';
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // Auto remove after 1.5 seconds
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 1500);
            }
            
            // Timer variables - explicitly initialized
            let startTime = 0;
            let lapStartTime = 0;
            let totalTime = 0;
            let isRunning = false;
            let timerInterval = null;
            let lapNumber = 0;
            let prevLapTime = 0;
            let lastLapTime = 0;
            
            // Debounce tracking for double-tap prevention
            let lastStartLapTime = 0;
            const startLapDebounceTime = 1000; // 1 second debounce as requested
            
            // Array to store lap times
            let lapTimes = [];
            
            // Display mode - false = show lap time, true = show diff from target
            let showDiff = false;
            
            // DOM elements
            const totalTimeEl = document.getElementById('totalTime');
            const currentLapEl = document.getElementById('currentLap');
            const btnStartLap = document.getElementById('btnStartLap');
            const btnStop = document.getElementById('btnStop');
            const btnReset = document.getElementById('btnReset');
            const historyBody = document.getElementById('historyBody');
            const fullscreenLap = document.getElementById('fullscreenLap');
            const lapLarge = document.getElementById('lapLarge');
            const btnBack = document.getElementById('btnBack');
            const targetTimeInput = document.getElementById('targetTime');
            const copyHistoryBtn = document.getElementById('copyHistory');
            
            // Performance analysis elements
            const bestLapEl = document.getElementById('bestLap');
            const avgLapEl = document.getElementById('avgLap');
            const targetDiffEl = document.getElementById('targetDiff');
            const lapChartEl = document.getElementById('lapChart');
            
            // Toggle buttons for display mode
            const lapTimeBtn = document.getElementById('lapTimeBtn');
            const diffBtn = document.getElementById('diffBtn');
            
            // Initialize buttons
            btnStop.disabled = true;
            
            // Format time function with two decimal places, but hide trailing zeros
            function formatTime(timeInMs) {
                const minutes = Math.floor(timeInMs / 60000);
                const seconds = Math.floor((timeInMs % 60000) / 1000);
                const tenths = Math.floor((timeInMs % 1000) / 100);
                const hundredths = Math.floor((timeInMs % 100) / 10);
                
                // Only show one decimal if the second decimal is 0
                if (hundredths === 0) {
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${tenths}`;
                } else {
                    const decimal = (tenths * 10 + hundredths);
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${decimal.toString().padStart(2, '0')}`;
                }
            }
            
            // Format time function with one decimal place for the main display
            function formatTimeOneDecimal(timeInMs) {
                const minutes = Math.floor(timeInMs / 60000);
                const seconds = Math.floor((timeInMs % 60000) / 1000);
                const tenths = Math.floor((timeInMs % 1000) / 100);
                
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${tenths}`;
            }
            
            // Format lap display time (only first digit and first decimal, rounded)
            function formatLapDisplayTime(timeInMs) {
                // Convert to seconds
                const totalSeconds = timeInMs / 1000;
                
                // For very short times (less than 10 seconds), show the full seconds value
                if (totalSeconds < 10) {
                    // Full seconds with first decimal
                    return totalSeconds.toFixed(1);
                } else {
                    // For longer times, just show the last digit of seconds and first decimal
                    // Extract only the ones digit (last digit of seconds part)
                    const onesDigit = Math.floor(totalSeconds) % 10;
                    
                    // Get the first decimal and round it
                    const firstDecimal = Math.round((totalSeconds * 10) % 10);
                    
                    // Ensure we only return exactly one digit for seconds and one for decimal
                    return `${onesDigit}.${firstDecimal}`;
                }
            }
            
            // Update timer display
            function updateDisplay() {
                const currentTime = Date.now();
                const elapsedTotal = isRunning ? (currentTime - startTime + totalTime) : totalTime;
                const elapsedLap = isRunning ? (currentTime - lapStartTime) : lastLapTime;
                
                totalTimeEl.textContent = formatTimeOneDecimal(elapsedTotal);
                currentLapEl.textContent = formatTimeOneDecimal(elapsedLap);
            }
            
            // Simple and effective scroll prevention
            function disableScroll() {
                document.body.classList.add('no-scroll');
                
                // Also prevent touchmove events
                document.addEventListener('touchmove', preventTouchMove, { passive: false });
            }
            
            function enableScroll() {
                document.body.classList.remove('no-scroll');
                
                // Remove touchmove prevention
                document.removeEventListener('touchmove', preventTouchMove);
            }
            
            function preventTouchMove(e) {
                // Allow scrolling on scrollable elements
                let isScrollable = false;
                let element = e.target;
                
                // Check if the element or any parent is scrollable
                while (element && !isScrollable) {
                    if (element.classList && element.classList.contains('history')) {
                        isScrollable = true;
                    }
                    element = element.parentElement;
                }
                
                // Only prevent default if not in a scrollable area
                if (!isScrollable) {
                    e.preventDefault();
                }
            }
            
            // Start/Lap button handler with debounce protection
            function handleStartLap() {
                console.log("Start/Lap button pressed");
                
                // Get the current time IMMEDIATELY to ensure accuracy
                const currentTime = Date.now();
                console.log("Current time:", currentTime);
                
                // DEBOUNCE CHECK: Prevent accidental double-taps
                const timeSinceLastPress = currentTime - lastStartLapTime;
                console.log("Time since last press:", timeSinceLastPress, "ms");
                
                if (timeSinceLastPress < startLapDebounceTime) {
                    console.log("Debounce protection active - ignoring press");
                    
                    // Visual feedback - briefly flash the button to indicate it's in cooldown
                    const originalColor = btnStartLap.style.backgroundColor;
                    btnStartLap.style.backgroundColor = '#888'; // Gray out the button
                    
                    // Show toast notification
                    showToast(`Please wait ${(startLapDebounceTime - timeSinceLastPress)/1000} sec`, false);
                    
                    // Reset the button color after a brief delay
                    setTimeout(() => {
                        btnStartLap.style.backgroundColor = originalColor;
                    }, 200);
                    
                    return; // Skip processing this press
                }
                
                // Update the last press time
                lastStartLapTime = currentTime;
                
                // NORMAL FUNCTIONALITY CONTINUES FROM HERE
                if (!isRunning) {
                    // Start the timer
                    console.log("Starting timer");
                    isRunning = true;
                    startTime = currentTime;
                    lapStartTime = currentTime;
                    btnStop.disabled = false;
                    
                    // Disable scrolling when timer starts
                    disableScroll();
                    
                    // Start the interval to update the display
                    timerInterval = setInterval(updateDisplay, 100);
                    
                    // Change button text
                    btnStartLap.textContent = "Lap";
                } else {
                    // Record lap
                    console.log("Recording lap");
                    console.log("Lap start time:", lapStartTime);
                    const lapTime = currentTime - lapStartTime;
                    console.log("Calculated lap time:", lapTime);
                    
                    // Store lap time FIRST before any display updates
                    // This guarantees we have the correct value 
                    const capturedLapTime = lapTime;
                    
                    // Update history
                    addLapToHistory(capturedLapTime);
                    
                    // Reset lap timer for next lap
                    lapStartTime = currentTime;
                    prevLapTime = capturedLapTime;
                    
                    // Show fullscreen lap time with the captured value
                    // Do this AFTER everything else to ensure correct time is used
                    console.log("Showing fullscreen with lap time:", capturedLapTime);
                    showFullscreenLap(capturedLapTime);
                }
            }
            
            // Stop button handler with debounce reset
            function handleStop() {
                if (isRunning) {
                    // Stop the timer
                    isRunning = false;
                    clearInterval(timerInterval);
                    
                    // Re-enable scrolling when timer stops
                    enableScroll();
                    
                    // Record the last lap time
                    const currentTime = Date.now();
                    lastLapTime = currentTime - lapStartTime;
                    totalTime += (currentTime - startTime);
                    
                    // Record the lap in history
                    addLapToHistory(lastLapTime);
                    
                    // Reset button text
                    btnStartLap.textContent = "Start/Lap";
                    
                    // Reset the debounce timer to allow immediate restart
                    lastStartLapTime = 0;
                    
                    btnStop.disabled = true;
                }
            }
            
            // Reset button handler with debounce reset
            function handleReset() {
                // Reset all timer variables
                isRunning = false;
                clearInterval(timerInterval);
                startTime = 0;
                lapStartTime = 0;
                totalTime = 0;
                lapNumber = 0;
                prevLapTime = 0;
                lastLapTime = 0;
                lapTimes = [];
                
                // Reset the debounce timer too
                lastStartLapTime = 0;
                
                // Re-enable scrolling
                enableScroll();
                
                // Reset display
                totalTimeEl.textContent = '00:00.0';
                currentLapEl.textContent = '00:00.0';
                historyBody.innerHTML = '';
                
                // Reset analysis
                bestLapEl.textContent = '--';
                avgLapEl.textContent = '--';
                targetDiffEl.textContent = '--';
                
                // Reset button text
                btnStartLap.textContent = "Start/Lap";
                
                // Reset chart
                if (window.lapChart && typeof window.lapChart.destroy === 'function') {
                    window.lapChart.destroy();
                }
                window.lapChart = null;
                
                btnStop.disabled = true;
            }
            
            // Back button handler
            function handleBack() {
                fullscreenLap.style.display = 'none';
            }
            
            // ===== IMPROVED TOUCH HANDLING =====
            // First, remove any existing event listeners to prevent duplicates
            function safeAddEventListener(element, event, handler, options) {
                // Check if element exists
                if (!element) return;
                
                // Add the event listener with optional options
                element.addEventListener(event, handler, options);
            }
            
            // Direct click handlers
            safeAddEventListener(btnStartLap, 'click', function(e) {
                console.log("Start/Lap click event");
                handleStartLap();
            });
            
            safeAddEventListener(btnStop, 'click', handleStop);
            safeAddEventListener(btnReset, 'click', handleReset);
            safeAddEventListener(btnBack, 'click', handleBack);
            
            // Touch handling for Start/Lap - special case
            safeAddEventListener(btnStartLap, 'touchstart', function(e) {
                console.log("Start/Lap touchstart event");
                // Prevent default to avoid any scrolling or zoom
                e.preventDefault();
                // Stop propagation to prevent any parent handlers
                e.stopPropagation();
                // Don't trigger click - directly call the handler
                // This prevents any timing issues between touch and click events
                handleStartLap();
            }, { passive: false });
            
            // Other button touch handlers
            safeAddEventListener(btnStop, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleStop();
            }, { passive: false });
            
            safeAddEventListener(btnReset, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleReset();
            }, { passive: false });
            
            safeAddEventListener(btnBack, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleBack();
            }, { passive: false });
            
            // Toggle display mode buttons
            function handleLapTimeBtn() {
                showDiff = false;
                lapTimeBtn.classList.add('toggle-active');
                diffBtn.classList.remove('toggle-active');
            }
            
            function handleDiffBtn() {
                showDiff = true;
                diffBtn.classList.add('toggle-active');
                lapTimeBtn.classList.remove('toggle-active');
            }
            
            lapTimeBtn.addEventListener('click', handleLapTimeBtn);
            diffBtn.addEventListener('click', handleDiffBtn);
            
            // Toggle display button handlers 
            safeAddEventListener(lapTimeBtn, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleLapTimeBtn();
            }, { passive: false });
            
            safeAddEventListener(diffBtn, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleDiffBtn();
            }, { passive: false });
            
            // Add lap to history
            function addLapToHistory(lapTime) {
                lapNumber++;
                const targetTime = parseFloat(targetTimeInput.value) * 1000; // Convert to ms
                
                // Add to lap times array
                lapTimes.push(lapTime);
                
                const row = document.createElement('tr');
                
                // Lap number
                const lapCell = document.createElement('td');
                lapCell.textContent = lapNumber;
                row.appendChild(lapCell);
                
                // Lap time
                const timeCell = document.createElement('td');
                timeCell.textContent = formatTime(lapTime);
                row.appendChild(timeCell);
                
                // Total time
                const totalCell = document.createElement('td');
                const calculatedTotal = isRunning ? 
                    totalTime + (Date.now() - startTime) : 
                    totalTime;
                totalCell.textContent = formatTime(calculatedTotal);
                row.appendChild(totalCell);
                
                // Vs previous lap
                const vsPrevCell = document.createElement('td');
                if (lapNumber > 1) {
                    const diff = lapTime - prevLapTime;
                    const sign = diff >= 0 ? '+' : '-';
                    vsPrevCell.textContent = `${sign}${formatTime(Math.abs(diff))}`;
                    vsPrevCell.style.color = diff >= 0 ? '#f44336' : '#4CAF50';
                } else {
                    vsPrevCell.textContent = '00:00.00';
                }
                row.appendChild(vsPrevCell);
                
                // Vs target
                const vsTargetCell = document.createElement('td');
                const diffTarget = lapTime - targetTime;
                const signTarget = diffTarget >= 0 ? '+' : '-';
                vsTargetCell.textContent = `${signTarget}${formatTime(Math.abs(diffTarget))}`;
                vsTargetCell.style.color = diffTarget >= 0 ? '#f44336' : '#4CAF50';
                row.appendChild(vsTargetCell);
                
                // Add row to history
                historyBody.appendChild(row);
                
                // Save last lap time
                lastLapTime = lapTime;
                
                // Update performance analysis
                updatePerformanceAnalysis();
            }
            
            // Show fullscreen lap display - COMPLETELY REWRITTEN
            function showFullscreenLap(lapTime) {
                console.log("==== FULLSCREEN DISPLAY ====");
                console.log("Original lap time passed:", lapTime);
                
                // CRITICAL: Force ensure we have a valid number
                // This guards against any possible issue with the lap time
                let safeTime = lapTime;
                
                if (isNaN(safeTime) || safeTime <= 0) {
                    console.error("❌ Invalid lap time detected:", lapTime);
                    console.log("Using fallback time of 1000ms");
                    safeTime = 1000; // Default to 1 second if there's an issue
                }
                
                // Double check we have a number
                safeTime = Number(safeTime);
                console.log("Safe lap time:", safeTime, "Type:", typeof safeTime);
                
                // Get target time
                const targetTime = parseFloat(targetTimeInput.value) * 1000; // Convert to ms
                console.log("Target time:", targetTime, "ms");
                
                // Set background color based on performance
                const isFasterThanTarget = safeTime < targetTime;
                const bgColor = isFasterThanTarget ? '#4CAF50' : '#f44336'; // Green if faster, Red if slower
                console.log("Performance:", isFasterThanTarget ? "FASTER than target ✅" : "SLOWER than target ❌");
                
                // Apply the background color
                fullscreenLap.style.backgroundColor = bgColor;
                
                // SIMPLIFIED DISPLAY LOGIC - ensures one path or the other
                if (showDiff) {
                    // Calculate difference from target
                    const diffMs = targetTime - safeTime;
                    const diffSeconds = diffMs / 1000;
                    console.log("Time difference:", diffSeconds, "seconds");
                    
                    // Format with sign and fixed decimal
                    const sign = diffSeconds >= 0 ? '+' : '';
                    const formattedDiff = sign + diffSeconds.toFixed(1);
                    console.log("Formatted difference:", formattedDiff);
                    
                    // Set display text
                    lapLarge.textContent = formattedDiff;
                } else {
                    // Show simple lap time (one digit and one decimal for readability)
                    const seconds = safeTime / 1000;
                    console.log("Seconds:", seconds);
                    
                    // Format for display - guaranteed simple format
                    let displayText;
                    if (seconds < 10) {
                        // Display full time for times under 10 seconds (common in track cycling)
                        displayText = seconds.toFixed(1);
                    } else {
                        // For longer times, just show last digit and first decimal
                        const lastDigit = Math.floor(seconds) % 10;
                        const firstDecimal = Math.floor((seconds * 10) % 10);
                        displayText = `${lastDigit}.${firstDecimal}`;
                    }
                    
                    console.log("Final display:", displayText);
                    lapLarge.textContent = displayText;
                }
                
                // Make display visible
                console.log("Making fullscreen display visible");
                fullscreenLap.style.display = 'flex';
            }
            
            // Update performance analysis
            function updatePerformanceAnalysis() {
                if (lapTimes.length === 0) {
                    return;
                }
                
                const targetTime = parseFloat(targetTimeInput.value) * 1000; // Convert to ms
                
                // Calculate best lap
                const bestLap = Math.min(...lapTimes);
                bestLapEl.textContent = formatTime(bestLap);
                
                // Calculate average lap
                const totalLapTime = lapTimes.reduce((sum, time) => sum + time, 0);
                const avgLap = totalLapTime / lapTimes.length;
                avgLapEl.textContent = formatTime(avgLap);
                
                // Calculate average absolute difference from target
                const totalAbsDiff = lapTimes.reduce((sum, time) => sum + Math.abs(time - targetTime), 0);
                const avgAbsDiff = totalAbsDiff / lapTimes.length;
                targetDiffEl.textContent = formatTime(avgAbsDiff);
                
                // Update lap chart
                updateLapChart();
            }
            
            // Update lap chart
            function updateLapChart() {
                if (!lapChartEl || lapTimes.length === 0) {
                    return;
                }
                
                const ctx = lapChartEl.getContext('2d');
                const targetTime = parseFloat(targetTimeInput.value) * 1000; // Convert to ms
                
                // Prepare data for chart
                const labels = Array.from({length: lapTimes.length}, (_, i) => `Lap ${i+1}`);
                const lapTimesInSeconds = lapTimes.map(t => t / 1000); // Convert ms to seconds
                
                // Get background colors based on performance
                const backgroundColors = lapTimes.map(lapTime => {
                    if (lapTime < targetTime) {
                        return 'rgba(76, 175, 80, 0.7)'; // Green
                    } else {
                        return 'rgba(244, 67, 54, 0.7)'; // Red
                    }
                });
                
                // Destroy previous chart if it exists
                if (window.lapChart && typeof window.lapChart.destroy === 'function') {
                    window.lapChart.destroy();
                }
                
                try {
                    // Create new chart
                    window.lapChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Lap Time (seconds)',
                                data: lapTimesInSeconds,
                                backgroundColor: backgroundColors,
                                borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    }
                                }
                            }
                        }
                    });
                    
                    // Add target time line
                    if (lapTimes.length > 0) {
                        const targetSeconds = targetTime / 1000;
                        const minY = Math.min(...lapTimesInSeconds) * 0.95;
                        const maxY = Math.max(...lapTimesInSeconds) * 1.05;
                        
                        window.lapChart.options.scales.y.min = minY;
                        window.lapChart.options.scales.y.max = maxY;
                        
                        window.lapChart.data.datasets.push({
                            type: 'line',
                            label: 'Target',
                            data: Array(lapTimes.length).fill(targetSeconds),
                            borderColor: 'rgba(255, 255, 255, 0.7)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        });
                        
                        window.lapChart.update();
                    }
                } catch (error) {
                    console.error('Chart creation error:', error);
                }
            }
            
            // Completely rewritten copy history function
            safeAddEventListener(copyHistoryBtn, 'click', function(e) {
                console.log("Copy button clicked");
                
                // Check if we have any data to copy
                const rows = historyBody.querySelectorAll('tr');
                if (rows.length === 0) {
                    showToast("No lap data to copy", false);
                    return;
                }
                
                // Update button state
                function updateButtonState(isSuccess) {
                    copyHistoryBtn.textContent = isSuccess ? 'Copied!' : 'Copy';
                    copyHistoryBtn.style.backgroundColor = isSuccess ? '#4CAF50' : '#607D8B';
                    setTimeout(() => {
                        copyHistoryBtn.textContent = 'Copy';
                        copyHistoryBtn.style.backgroundColor = '#607D8B';
                    }, 2000);
                }
                
                // Generate formatted text from lap history
                function generateHistoryText() {
                    // Create header
                    let text = 'Lap\tLap Time\tTotal Time\tvs Prev\tvs Target\n';
                    
                    // Format each row
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length > 0) {
                            const rowValues = Array.from(cells).map(cell => cell.textContent.trim());
                            text += rowValues.join('\t') + '\n';
                        }
                    });
                    
                    return text;
                }
                
                // Create manual copy popup if automatic methods fail
                function showManualCopyInterface(text) {
                    // Create modal backdrop
                    const modal = document.createElement('div');
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                    modal.style.zIndex = '9999';
                    modal.style.display = 'flex';
                    modal.style.flexDirection = 'column';
                    modal.style.alignItems = 'center';
                    modal.style.justifyContent = 'center';
                    modal.style.padding = '20px';
                    
                    // Create content container
                    const container = document.createElement('div');
                    container.style.backgroundColor = '#333';
                    container.style.width = '90%';
                    container.style.maxWidth = '600px';
                    container.style.borderRadius = '8px';
                    container.style.padding = '20px';
                    container.style.display = 'flex';
                    container.style.flexDirection = 'column';
                    container.style.gap = '15px';
                    
                    // Add title
                    const title = document.createElement('h3');
                    title.textContent = 'Copy Lap History';
                    title.style.color = 'white';
                    title.style.margin = '0';
                    
                    // Add instructions
                    const instructions = document.createElement('p');
                    instructions.textContent = 'Select all text and copy using Ctrl+C or Cmd+C:';
                    instructions.style.color = 'white';
                    instructions.style.margin = '0';
                    
                    // Add textarea with data
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.width = '100%';
                    textArea.style.height = '200px';
                    textArea.style.padding = '10px';
                    textArea.style.borderRadius = '4px';
                    textArea.style.backgroundColor = '#222';
                    textArea.style.color = 'white';
                    textArea.style.border = '1px solid #444';
                    
                    // Add buttons container
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.justifyContent = 'space-between';
                    buttonContainer.style.marginTop = '10px';
                    
                    // Try copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'Try Copy Again';
                    copyBtn.style.padding = '10px 20px';
                    copyBtn.style.backgroundColor = '#2196F3';
                    copyBtn.style.color = 'white';
                    copyBtn.style.border = 'none';
                    copyBtn.style.borderRadius = '4px';
                    copyBtn.style.cursor = 'pointer';
                    
                    // Close button
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = 'Close';
                    closeBtn.style.padding = '10px 20px';
                    closeBtn.style.backgroundColor = '#607D8B';
                    closeBtn.style.color = 'white';
                    closeBtn.style.border = 'none';
                    closeBtn.style.borderRadius = '4px';
                    closeBtn.style.cursor = 'pointer';
                    
                    // Assemble the modal
                    buttonContainer.appendChild(copyBtn);
                    buttonContainer.appendChild(closeBtn);
                    
                    container.appendChild(title);
                    container.appendChild(instructions);
                    container.appendChild(textArea);
                    container.appendChild(buttonContainer);
                    
                    modal.appendChild(container);
                    document.body.appendChild(modal);
                    
                    // Select text for easy copying
                    setTimeout(() => {
                        textArea.focus();
                        textArea.select();
                    }, 100);
                    
                    // Button event handlers
                    copyBtn.addEventListener('click', function() {
                        textArea.select();
                        document.execCommand('copy');
                        showToast('Text selected! Use Ctrl+C to copy', true);
                    });
                    
                    closeBtn.addEventListener('click', function() {
                        document.body.removeChild(modal);
                    });
                }
                
                // Execute copy with multiple fallbacks
                async function executeCopy() {
                    const historyText = generateHistoryText();
                    console.log("Generated history text:", historyText.slice(0, 100) + "...");
                    
                    try {
                        // Method 1: Modern Clipboard API (most reliable)
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            try {
                                await navigator.clipboard.writeText(historyText);
                                console.log("Clipboard API success");
                                updateButtonState(true);
                                showToast('Copied to clipboard!', true);
                                return;
                            } catch (err) {
                                console.error("Clipboard API error:", err);
                                // Fall through to next method
                            }
                        }
                        
                        // Method 2: document.execCommand (older browsers)
                        const textarea = document.createElement('textarea');
                        textarea.value = historyText;
                        textarea.style.position = 'fixed';
                        textarea.style.left = '-999999px';
                        textarea.style.top = '-999999px';
                        document.body.appendChild(textarea);
                        textarea.focus();
                        textarea.select();
                        
                        const success = document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        if (success) {
                            console.log("execCommand success");
                            updateButtonState(true);
                            showToast('Copied to clipboard!', true);
                            return;
                        }
                        
                        // Method 3: Show manual interface as last resort
                        console.log("Falling back to manual copy interface");
                        showManualCopyInterface(historyText);
                        
                    } catch (err) {
                        console.error("Copy operation failed:", err);
                        showToast('Could not copy automatically', false);
                        showManualCopyInterface(historyText);
                    }
                }
                
                // Start the copy process
                executeCopy();
            });
            
            // Also add touch handler for copy button
            safeAddEventListener(copyHistoryBtn, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                copyHistoryBtn.click();
            }, { passive: false });
            
            // Universal touch handler for all other buttons - for better touch response
            document.querySelectorAll('.btn:not(#btnStartLap):not(#btnStop):not(#btnReset):not(#btnBack), .toggle-btn:not(#lapTimeBtn):not(#diffBtn)').forEach(btn => {
                safeAddEventListener(btn, 'touchstart', function(e) {
                    console.log("Generic button touchstart:", e.target.id || "unknown button");
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Highlight the button visually to show it's being pressed
                    const originalBg = e.target.style.backgroundColor;
                    e.target.style.backgroundColor = '#555';
                    
                    // Direct action instead of synthetic click
                    setTimeout(function() {
                        // Reset appearance
                        e.target.style.backgroundColor = originalBg;
                        // Trigger click without delay
                        e.target.click();
                    }, 50); // Very slight delay for visual feedback
                }, { passive: false });
            });
        });
    </script>
</body>
</html>