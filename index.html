<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Cycling Lap Timer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #222;
            color: white;
            transition: background-color 0.3s;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #333;
            border-radius: 8px;
        }
        
        .section-title {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .timer-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .time-box {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #444;
            border-radius: 5px;
            margin: 0 5px;
        }
        
        .time-box:first-child {
            margin-left: 0;
        }
        
        .time-box:last-child {
            margin-right: 0;
        }
        
        .time-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .time-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
        }
        
        .btn {
            flex: 1;
            margin: 0 5px;
            padding: 33px 15px; /* Increased height by another 50% */
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .btn:first-child {
            margin-left: 0;
        }
        
        .btn:last-child {
            margin-right: 0;
        }
        
        .btn-start {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-stop {
            background-color: #f44336;
            color: white;
        }
        
        .btn-reset {
            background-color: #607D8B;
            color: white;
        }
        
        .btn-back {
            background-color: #607D8B;
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 2;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 5px;
        }
        
        .input-group:first-child {
            margin-left: 0;
        }
        
        .input-group:last-child {
            margin-right: 0;
        }
        
        .input-label {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .input-field {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
        }
        
        .half-width {
            width: 50%;
        }
        
        .toggle-container {
            display: flex;
            width: 100%;
            border-radius: 5px;
            overflow: hidden;
            background-color: #333;
            border: 1px solid #555;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #333;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .toggle-btn:first-child {
            border-right: 1px solid #555;
        }
        
        .toggle-active {
            background-color: #2196F3;
            color: white;
            font-weight: bold;
        }
        
        .analysis-grid {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .analysis-item {
            flex: 0 1 auto;
            background-color: #444;
            padding: 8px 16px;
            border-radius: 5px;
            text-align: center;
            min-width: 0;
            display: inline-flex;
            align-items: center;
        }
        
        .analysis-label {
            font-size: 0.9rem;
            margin-right: 5px;
            opacity: 0.8;
        }
        
        .analysis-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .lap-chart-container {
            width: 100%;
            height: 200px;
            background-color: #444;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .history {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th, 
        .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        
        .history-controls {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .fullscreen-lap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .lap-large {
            font-size: 35rem; /* Increased from 25rem */
            font-weight: 900;
            line-height: 1;
            text-shadow: 
                -6px -6px 0 #000,
                6px -6px 0 #000,
                -6px 6px 0 #000,
                6px 6px 0 #000,
                0 -8px 14px rgba(0, 0, 0, 0.7),
                0 8px 14px rgba(0, 0, 0, 0.7);
        }
        
        body.no-scroll {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        /* Positions for main sections */
        #timerSection {
            order: 1;
        }
        
        #settingsSection {
            order: 2;
        }
        
        #analysisSection {
            order: 3;
        }
        
        #shareSection {
            order: 4;
        }
        
        #historySection {
            order: 5; /* Ensures it's at the bottom */
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .time-value {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 27px 8px; /* Increased height by 50% for mobile as well */
                font-size: 1rem;
            }
            
            .lap-large {
                font-size: 28rem; /* Increased from 20rem */
            }
            
            .analysis-value {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Timer Section -->
        <div class="section" id="timerSection">
            <div class="timer-display">
                <div class="time-box">
                    <div class="time-label">Laps Left</div>
                    <div class="time-value" id="lapsLeft">10</div>
                </div>
                <div class="time-box">
                    <div class="time-label">Current Lap</div>
                    <div class="time-value" id="currentLap">00:00.0</div>
                </div>
                <div class="time-box">
                    <div class="time-label">Total Time</div>
                    <div class="time-value" id="totalTime">00:00.0</div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-start" id="btnStartLap">Start/Lap</button>
                <button class="btn btn-stop" id="btnStop">Stop</button>
                <button class="btn btn-reset" id="btnReset">Reset</button>
            </div>
        </div>
        
        <!-- Settings Section -->
        <div class="section" id="settingsSection">
            <h2 class="section-title">Settings</h2>
            <div class="settings-row">
                <div class="input-group">
                    <label class="input-label" for="targetTime">Target Time (s)</label>
                    <input type="number" class="input-field half-width" id="targetTime" value="20" min="0" step="0.1">
                </div>
                <div class="input-group">
                    <label class="input-label" for="targetLaps">Number of Laps</label>
                    <input type="number" class="input-field half-width" id="targetLaps" value="10" min="1" step="1">
                </div>
                <div class="input-group">
                    <label class="input-label">Fullscreen Display</label>
                    <div class="toggle-container">
                        <button type="button" id="lapTimeBtn" class="toggle-btn toggle-active">Lap Time</button>
                        <button type="button" id="diffBtn" class="toggle-btn">Diff from Target</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Section -->
        <div class="section" id="analysisSection">
            <h2 class="section-title">Performance Analysis</h2>
            <div class="analysis-grid">
                <div class="analysis-item">
                    <span class="analysis-label">Best:</span>
                    <span class="analysis-value" id="bestLap">--</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Diff:</span>
                    <span class="analysis-value" id="targetDiff">--</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Avg:</span>
                    <span class="analysis-value" id="avgLap">--</span>
                </div>
            </div>
            <div class="lap-chart-container">
                <canvas id="lapChart"></canvas>
            </div>
        </div>
        
        <!-- Share History Section (initially hidden) - REMOVED -->
        <!-- Lap History Section (always at the bottom) -->
        <div class="section" id="historySection">
            <h2 class="section-title">Lap History <button id="copyHistory" class="btn" style="font-size: 0.9rem; padding: 8px 15px; float: right;">Copy</button></h2>
            <div class="history">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Lap</th>
                            <th>Lap Time</th>
                            <th>Total Time</th>
                            <th>vs Prev</th>
                            <th>vs Target</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- History entries will go here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="fullscreen-lap" id="fullscreenLap">
        <button class="btn btn-back" id="btnBack">Back</button>
        <div class="lap-large" id="lapLarge">0</div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ðŸš€ Track Cycling Lap Timer Initializing");
            
            // Universal toast notification function
            function showToast(message, isSuccess) {
                // Remove any existing toast
                const existingToast = document.getElementById('notification-toast');
                if (existingToast) {
                    document.body.removeChild(existingToast);
                }
                
                // Create new toast
                const toast = document.createElement('div');
                toast.id = 'notification-toast';
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
                toast.style.color = 'white';
                toast.style.padding = '10px 20px';
                toast.style.borderRadius = '5px';
                toast.style.zIndex = '1000';
                toast.style.textAlign = 'center';
                toast.style.boxShadow = '0 3px 6px rgba(0,0,0,0.2)';
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // Auto remove after 1.5 seconds
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 1500);
            }
            
            // Timer variables - explicitly initialized
            let startTime = 0;
            let lapStartTime = 0;
            let totalTime = 0;
            let isRunning = false;
            let timerInterval = null;
            let lapNumber = 0;
            let prevLapTime = 0;
            let lastLapTime = 0;
            let lapsRemaining = 10; // Initialize with default
            
            // Debounce tracking for double-tap prevention
            let lastStartLapTime = 0;
            const startLapDebounceTime = 1000; // 1 second debounce as requested
            
            // Array to store lap times
            let lapTimes = [];
            
            // Display mode - false = show lap time, true = show diff from target
            let showDiff = false;
            
            // DOM elements
            const totalTimeEl = document.getElementById('totalTime');
            const currentLapEl = document.getElementById('currentLap');
            const btnStartLap = document.getElementById('btnStartLap');
            const btnStop = document.getElementById('btnStop');
            const btnReset = document.getElementById('btnReset');
            const historyBody = document.getElementById('historyBody');
            const fullscreenLap = document.getElementById('fullscreenLap');
            const lapLarge = document.getElementById('lapLarge');
            const btnBack = document.getElementById('btnBack');
            const targetTimeInput = document.getElementById('targetTime');
            const targetLapsInput = document.getElementById('targetLaps');
            const lapsLeftEl = document.getElementById('lapsLeft');
            
            // Performance analysis elements
            const bestLapEl = document.getElementById('bestLap');
            const avgLapEl = document.getElementById('avgLap');
            const targetDiffEl = document.getElementById('targetDiff');
            const lapChartEl = document.getElementById('lapChart');
            
            // Toggle buttons for display mode
            const lapTimeBtn = document.getElementById('lapTimeBtn');
            const diffBtn = document.getElementById('diffBtn');
            
            // Initialize the laps remaining display
            lapsLeftEl.textContent = targetLapsInput.value;
            
            // Update laps when the input changes
            targetLapsInput.addEventListener('change', function() {
                lapsRemaining = parseInt(targetLapsInput.value, 10);
                lapsLeftEl.textContent = lapsRemaining;
            });
            
            // Format time function with two decimal places, but hide trailing zeros
            function formatTime(timeInMs) {
                const minutes = Math.floor(timeInMs / 60000);
                const seconds = Math.floor((timeInMs % 60000) / 1000);
                const tenths = Math.floor((timeInMs % 1000) / 100);
                const hundredths = Math.floor((timeInMs % 100) / 10);
                
                // Only show one decimal if the second decimal is 0
                if (hundredths === 0) {
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${tenths}`;
                } else {
                    const decimal = (tenths * 10 + hundredths);
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${decimal.toString().padStart(2, '0')}`;
                }
            }
            
            // Format time function with one decimal place for the main display
            function formatTimeOneDecimal(timeInMs) {
                const minutes = Math.floor(timeInMs / 60000);
                const seconds = Math.floor((timeInMs % 60000) / 1000);
                const tenths = Math.floor((timeInMs % 1000) / 100);
                
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${tenths}`;
            }
            
            // Format lap display time (only first digit and first decimal, rounded)
            function formatLapDisplayTime(timeInMs) {
                // Convert to seconds
                const totalSeconds = timeInMs / 1000;
                
                // For very short times (less than 10 seconds), show the full seconds value
                if (totalSeconds < 10) {
                    // Full seconds with first decimal
                    return totalSeconds.toFixed(1);
                } else {
                    // For longer times, just show the last digit of seconds and first decimal
                    // Extract only the ones digit (last digit of seconds part)
                    const onesDigit = Math.floor(totalSeconds) % 10;
                    
                    // Get the first decimal and round it
                    const firstDecimal = Math.round((totalSeconds * 10) % 10);
                    
                    // Ensure we only return exactly one digit for seconds and one for decimal
                    return `${onesDigit}.${firstDecimal}`;
                }
            }
            
            // Update timer display
            function updateDisplay() {
                const currentTime = Date.now();
                const elapsedTotal = isRunning ? (currentTime - startTime + totalTime) : totalTime;
                const elapsedLap = isRunning ? (currentTime - lapStartTime) : lastLapTime;
                
                totalTimeEl.textContent = formatTimeOneDecimal(elapsedTotal);
                currentLapEl.textContent = formatTimeOneDecimal(elapsedLap);
            }
            
            // Simple and effective scroll prevention
            function disableScroll() {
                document.body.classList.add('no-scroll');
                
                // Also prevent touchmove events
                document.addEventListener('touchmove', preventTouchMove, { passive: false });
            }
            
            function enableScroll() {
                document.body.classList.remove('no-scroll');
                
                // Remove touchmove prevention
                document.removeEventListener('touchmove', preventTouchMove);
            }
            
            function preventTouchMove(e) {
                // Allow scrolling on scrollable elements
                let isScrollable = false;
                let element = e.target;
                
                // Check if the element or any parent is scrollable
                while (element && !isScrollable) {
                    if (element.classList && element.classList.contains('history')) {
                        isScrollable = true;
                    }
                    element = element.parentElement;
                }
                
                // Only prevent default if not in a scrollable area
                if (!isScrollable) {
                    e.preventDefault();
                }
            }
            
            // Start/Lap button handler with debounce protection
            function handleStartLap() {
                console.log("Start/Lap button pressed");
                
                // Get the current time IMMEDIATELY to ensure accuracy
                const currentTime = Date.now();
                console.log("Current time:", currentTime);
                
                // DEBOUNCE CHECK: Prevent accidental double-taps
                const timeSinceLastPress = currentTime - lastStartLapTime;
                console.log("Time since last press:", timeSinceLastPress, "ms");
                
                if (timeSinceLastPress < startLapDebounceTime) {
                    console.log("Debounce protection active - ignoring press");
                    
                    // Visual feedback - briefly flash the button to indicate it's in cooldown
                    const originalColor = btnStartLap.style.backgroundColor;
                    btnStartLap.style.backgroundColor = '#888'; // Gray out the button
                    
                    // Show toast notification
                    showToast(`Please wait ${(startLapDebounceTime - timeSinceLastPress)/1000} sec`, false);
                    
                    // Reset the button color after a brief delay
                    setTimeout(() => {
                        btnStartLap.style.backgroundColor = originalColor;
                    }, 200);
                    
                    return; // Skip processing this press
                }
                
                // Update the last press time
                lastStartLapTime = currentTime;
                
                // NORMAL FUNCTIONALITY CONTINUES FROM HERE
                if (!isRunning) {
                    // Start the timer
                    console.log("Starting timer");
                    isRunning = true;
                    startTime = currentTime;
                    lapStartTime = currentTime;
                    btnStop.disabled = false;
                    
                    // Initialize lap counter from settings and decrease by 1 for the start
                    lapsRemaining = parseInt(targetLapsInput.value, 10);
                    if (lapsRemaining > 0) {
                        lapsRemaining--; // Decrease by 1 when starting
                    }
                    lapsLeftEl.textContent = lapsRemaining;
                    
                    // Disable scrolling when timer starts
                    disableScroll();
                    
                    // Start the interval to update the display
                    timerInterval = setInterval(updateDisplay, 100);
                    
                    // Change button text
                    btnStartLap.textContent = "Lap";
                } else {
                    // Record lap
                    console.log("Recording lap");
                    console.log("Lap start time:", lapStartTime);
                    const lapTime = currentTime - lapStartTime;
                    console.log("Calculated lap time:", lapTime);
                    
                    // Store lap time FIRST before any display updates
                    // This guarantees we have the correct value 
                    const capturedLapTime = lapTime;
                    
                    // Update history
                    addLapToHistory(capturedLapTime);
                    
                    // Update lap counter
                    if (lapsRemaining > 0) {
                        lapsRemaining--;
                        lapsLeftEl.textContent = lapsRemaining;
                        
                        // Check if all laps completed
                        if (lapsRemaining === 0) {
                            // Visual indication that laps are complete
                            lapsLeftEl.style.color = '#4CAF50';
                            showToast("All laps completed!", true);
                        }
                    }
                    
                    // Reset lap timer for next lap
                    lapStartTime = currentTime;
                    prevLapTime = capturedLapTime;
                    
                    // Show fullscreen lap time with the captured value
                    // Do this AFTER everything else to ensure correct time is used
                    console.log("Showing fullscreen with lap time:", capturedLapTime);
                    showFullscreenLap(capturedLapTime);
                }
            }
            
            // Stop button handler with debounce reset
            function handleStop() {
                if (isRunning) {
                    // Stop the timer
                    isRunning = false;
                    clearInterval(timerInterval);
                    
                    // Re-enable scrolling when timer stops
                    enableScroll();
                    
                    // Record the time values but don't add to history
                    const currentTime = Date.now();
                    lastLapTime = currentTime - lapStartTime;
                    totalTime += (currentTime - startTime);
                    
                    // Reset button text
                    btnStartLap.textContent = "Start/Lap";
                    
                    // Reset the debounce timer to allow immediate restart
                    lastStartLapTime = 0;
                    
                    btnStop.disabled = true;
                }
            }
            
            // Reset button handler with debounce reset
            function handleReset() {
                // Reset all timer variables
                isRunning = false;
                clearInterval(timerInterval);
                startTime = 0;
                lapStartTime = 0;
                totalTime = 0;
                lapNumber = 0;
                prevLapTime = 0;
                lastLapTime = 0;
                lapTimes = [];
                
                // Reset the debounce timer too
                lastStartLapTime = 0;
                
                // Reset lap counter from settings
                lapsRemaining = parseInt(targetLapsInput.value, 10);
                lapsLeftEl.textContent = lapsRemaining;
                lapsLeftEl.style.color = ''; // Reset color
                
                // Re-enable scrolling
                enableScroll();
                
                // Reset display
                totalTimeEl.textContent = '00:00.0';
                currentLapEl.textContent = '00:00.0';
                historyBody.innerHTML = '';
                
                // Reset analysis
                bestLapEl.textContent = '--';
                avgLapEl.textContent = '--';
                targetDiffEl.textContent = '--';
                
                // Reset button text
                btnStartLap.textContent = "Start/Lap";
                
                // Reset chart
                if (window.lapChart && typeof window.lapChart.destroy === 'function') {
                    window.lapChart.destroy();
                }
                window.lapChart = null;
                
                btnStop.disabled = true;
            }
            
            // Back button handler
            function handleBack() {
                fullscreenLap.style.display = 'none';
            }
            
            // ===== IMPROVED TOUCH HANDLING =====
            // First, remove any existing event listeners to prevent duplicates
            function safeAddEventListener(element, event, handler, options) {
                // Check if element exists
                if (!element) return;
                
                // Add the event listener with optional options
                element.addEventListener(event, handler, options);
            }
            
            // Direct click handlers
            safeAddEventListener(btnStartLap, 'click', function(e) {
                console.log("Start/Lap click event");
                handleStartLap();
            });
            
            safeAddEventListener(btnStop, 'click', handleStop);
            safeAddEventListener(btnReset, 'click', handleReset);
            safeAddEventListener(btnBack, 'click', handleBack);
            
            // Touch handling for Start/Lap - special case
            safeAddEventListener(btnStartLap, 'touchstart', function(e) {
                console.log("Start/Lap touchstart event");
                // Prevent default to avoid any scrolling or zoom
                e.preventDefault();
                // Stop propagation to prevent any parent handlers
                e.stopPropagation();
                // Don't trigger click - directly call the handler
                // This prevents any timing issues between touch and click events
                handleStartLap();
            }, { passive: false });
            
            // Other button touch handlers
            safeAddEventListener(btnStop, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleStop();
            }, { passive: false });
            
            safeAddEventListener(btnReset, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleReset();
            }, { passive: false });
            
            safeAddEventListener(btnBack, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleBack();
            }, { passive: false });
            
            // Toggle display button handlers 
            safeAddEventListener(lapTimeBtn, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleLapTimeBtn();
            }, { passive: false });
            
            safeAddEventListener(diffBtn, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleDiffBtn();
            }, { passive: false });
            
            // Toggle display mode buttons
            function handleLapTimeBtn() {
                showDiff = false;
                lapTimeBtn.classList.add('toggle-active');
                diffBtn.classList.remove('toggle-active');
            }
            
            function handleDiffBtn() {
                showDiff = true;
                diffBtn.classList.add('toggle-active');
                lapTimeBtn.classList.remove('toggle-active');
            }
            
            safeAddEventListener(lapTimeBtn, 'click', handleLapTimeBtn);
            safeAddEventListener(diffBtn, 'click', handleDiffBtn);
            
            // Universal touch handler for all other buttons - for better touch response
            document.querySelectorAll('.btn:not(#btnStartLap):not(#btnStop):not(#btnReset):not(#btnBack), .toggle-btn:not(#lapTimeBtn):not(#diffBtn)').forEach(btn => {
                safeAddEventListener(btn, 'touchstart', function(e) {
                    console.log("Generic button touchstart:", e.target.id || "unknown button");
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Highlight the button visually to show it's being pressed
                    const originalBg = e.target.style.backgroundColor;
                    e.target.style.backgroundColor = '#555';
                    
                    // Direct action instead of synthetic click
                    setTimeout(function() {
                        // Reset appearance
                        e.target.style.backgroundColor = originalBg;
                        // Trigger click without delay
                        e.target.click();
                    }, 50); // Very slight delay for visual feedback
                }, { passive: false });
            });
            
            // Add lap to history
            function addLapToHistory(lapTime) {
                lapNumber++;
                const targetTime = parseFloat(targetTimeInput.value) * 1000; // Convert to ms
                
                // Add to lap times array
                lapTimes.push(lapTime);
                
                const row = document.createElement('tr');
                
                // Lap number
                const lapCell = document.createElement('td');
                lapCell.textContent = lapNumber;
                row.appendChild(lapCell);
                
                // Lap time
                const timeCell = document.createElement('td');
                timeCell.textContent = formatTime(lapTime);
                row.appendChild(timeCell);
                
                // Total time
                const totalCell = document.createElement('td');
                const calculatedTotal = isRunning ? 
                    totalTime + (Date.now() - startTime) : 
                    totalTime;
                totalCell.textContent = formatTime(calculatedTotal);
                row.appendChild(totalCell);
                
                // Vs previous lap
                const vsPrevCell = document.createElement('td');
                if (lapNumber > 1) {
                    const diff = lapTime - prevLapTime;
                    const sign = diff >= 0 ? '+' : '-';
                    vsPrevCell.textContent = `${sign}${formatTime(Math.abs(diff))}`;
                    vsPrevCell.style.color = diff >= 0 ? '#f44336' : '#4CAF50';
                } else {
                    vsPrevCell.textContent = '00:00.00';
                }
                row.appendChild(vsPrevCell);
                
                // Vs target
                const vsTargetCell = document.createElement('td');
                const diffTarget = lapTime - targetTime;
                const signTarget = diffTarget >= 0 ? '+' : '-';
                vsTargetCell.textContent = `${signTarget}${formatTime(Math.abs(diffTarget))}`;
                vsTargetCell.style.color = diffTarget >= 0 ? '#f44336' : '#4CAF50';
                row.appendChild(vsTargetCell);
                
                // Add row to history
                historyBody.appendChild(row);
                
                // Save last lap time
                lastLapTime = lapTime;
                
                // Update performance analysis
                updatePerformanceAnalysis();
            }
            
            // Show fullscreen lap display - COMPLETELY REWRITTEN
            function showFullscreenLap(lapTime) {
                console.log("==== FULLSCREEN DISPLAY ====");
                console.log("Original lap time passed:", lapTime);
                
                // CRITICAL: Force ensure we have a valid number
                // This guards against any possible issue with the lap time
                let safeTime = lapTime;
                
                if (isNaN(safeTime) || safeTime <= 0) {
                    console.error("âŒ Invalid lap time detected:", lapTime);
                    console.log("Using fallback time of 1000ms");
                    safeTime = 1000; // Default to 1 second if there's an issue
                }
                
                // Double check we have a number
                safeTime = Number(safeTime);
                console.log("Safe lap time:", safeTime, "Type:", typeof safeTime);
                
                // Get target time
                const targetTime = parseFloat(targetTimeInput.value) * 1000; // Convert to ms
                console.log("Target time:", targetTime, "ms");
                
                // Set background color based on performance
                const isFasterThanTarget = safeTime < targetTime;
                const bgColor = isFasterThanTarget ? '#4CAF50' : '#f44336'; // Green if faster, Red if slower
                console.log("Performance:", isFasterThanTarget ? "FASTER than target âœ…" : "SLOWER than target âŒ");
                
                // Apply the background color
                fullscreenLap.style.backgroundColor = bgColor;
                
                // SIMPLIFIED DISPLAY LOGIC - ensures one path or the other
                if (showDiff) {
                    // Calculate difference from target
                    const diffMs = targetTime - safeTime;
                    const diffSeconds = diffMs / 1000;
                    console.log("Time difference:", diffSeconds, "seconds");
                    
                    // Format with sign and fixed decimal
                    const sign = diffSeconds >= 0 ? '+' : '';
                    const formattedDiff = sign + diffSeconds.toFixed(1);
                    console.log("Formatted difference:", formattedDiff);
                    
                    // Set display text
                    lapLarge.textContent = formattedDiff;
                } else {
                    // Show simple lap time (one digit and one decimal for readability)
                    const seconds = safeTime / 1000;
                    console.log("Seconds:", seconds);
                    
                    // Format for display - guaranteed simple format
                    let displayText;
                    if (seconds < 10) {
                        // Display full time for times under 10 seconds (common in track cycling)
                        displayText = seconds.toFixed(1);
                    } else {
                        // For longer times, just show last digit and first decimal
                        const lastDigit = Math.floor(seconds) % 10;
                        const firstDecimal = Math.floor((seconds * 10) % 10);
                        displayText = `${lastDigit}.${firstDecimal}`;
                    }
                    
                    console.log("Final display:", displayText);
                    lapLarge.textContent = displayText;
                }
                
                // Make display visible
                console.log("Making fullscreen display visible");
                fullscreenLap.style.display = 'flex';
            }
            
            // Update performance analysis
            function updatePerformanceAnalysis() {
                if (lapTimes.length === 0) {
                    return;
                }
                
                const targetTime = parseFloat(targetTimeInput.value) * 1000; // Convert to ms
                
                // Calculate best lap
                const bestLap = Math.min(...lapTimes);
                bestLapEl.textContent = formatTime(bestLap);
                
                // Calculate average lap
                const totalLapTime = lapTimes.reduce((sum, time) => sum + time, 0);
                const avgLap = totalLapTime / lapTimes.length;
                avgLapEl.textContent = formatTime(avgLap);
                
                // Calculate average absolute difference from target
                const totalAbsDiff = lapTimes.reduce((sum, time) => sum + Math.abs(time - targetTime), 0);
                const avgAbsDiff = totalAbsDiff / lapTimes.length;
                targetDiffEl.textContent = formatTime(avgAbsDiff);
                
                // Update lap chart
                updateLapChart();
            }
            
            // Update lap chart
            function updateLapChart() {
                if (!lapChartEl || lapTimes.length === 0) {
                    return;
                }
                
                const ctx = lapChartEl.getContext('2d');
                const targetTime = parseFloat(targetTimeInput.value) * 1000; // Convert to ms
                
                // Prepare data for chart
                const labels = Array.from({length: lapTimes.length}, (_, i) => `Lap ${i+1}`);
                const lapTimesInSeconds = lapTimes.map(t => t / 1000); // Convert ms to seconds
                
                // Get background colors based on performance
                const backgroundColors = lapTimes.map(lapTime => {
                    if (lapTime < targetTime) {
                        return 'rgba(76, 175, 80, 0.7)'; // Green
                    } else {
                        return 'rgba(244, 67, 54, 0.7)'; // Red
                    }
                });
                
                // Destroy previous chart if it exists
                if (window.lapChart && typeof window.lapChart.destroy === 'function') {
                    window.lapChart.destroy();
                }
                
                try {
                    // Create new chart
                    window.lapChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Lap Time (seconds)',
                                data: lapTimesInSeconds,
                                backgroundColor: backgroundColors,
                                borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    }
                                }
                            }
                        }
                    });
                    
                    // Add target time line
                    if (lapTimes.length > 0) {
                        const targetSeconds = targetTime / 1000;
                        const minY = Math.min(...lapTimesInSeconds) * 0.95;
                        const maxY = Math.max(...lapTimesInSeconds) * 1.05;
                        
                        window.lapChart.options.scales.y.min = minY;
                        window.lapChart.options.scales.y.max = maxY;
                        
                        window.lapChart.data.datasets.push({
                            type: 'line',
                            label: 'Target',
                            data: Array(lapTimes.length).fill(targetSeconds),
                            borderColor: 'rgba(255, 255, 255, 0.7)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        });
                        
                        window.lapChart.update();
                    }
                } catch (error) {
                    console.error('Chart creation error:', error);
                }
            }
            
            // Mobile-friendly in-place copy solution - completely rewritten
            const copyHistoryBtn = document.getElementById('copyHistory');
            
            // Generate formatted text from lap history
            function generateHistoryText() {
                const rows = historyBody.querySelectorAll('tr');
                
                // Create header
                let text = 'Lap\tLap Time\tTotal Time\tvs Prev\tvs Target\n';
                
                // Format each row
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) {
                        const rowValues = Array.from(cells).map(cell => cell.textContent.trim());
                        text += rowValues.join('\t') + '\n';
                    }
                });
                
                return text;
            }
            
            // Track if the overlay is currently shown to prevent multiple overlays
            let isOverlayShown = false;
            
            // Detect iOS for specialized handling
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            // Simple copy approach - completely rewritten with no event delegation
            safeAddEventListener(copyHistoryBtn, 'click', function() {
                // Prevent multiple overlays
                if (isOverlayShown) return;
                
                // Check if we have data
                const rows = historyBody.querySelectorAll('tr');
                if (rows.length === 0) {
                    showToast("No lap data to copy", false);
                    return;
                }
                
                // Generate text
                const text = generateHistoryText();
                
                // Set overlay flag
                isOverlayShown = true;
                
                // Get history section
                const historySection = document.getElementById('historySection');
                historySection.style.position = 'relative'; // Ensure positioning context
                
                // Create overlay container
                const overlay = document.createElement('div');
                overlay.id = "copyOverlay";
                overlay.style.position = 'absolute';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.right = '0';
                overlay.style.bottom = '0';
                overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
                overlay.style.zIndex = '100';
                overlay.style.display = 'flex';
                overlay.style.flexDirection = 'column';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.style.padding = '20px';
                overlay.style.touchAction = 'none'; // Prevent scrolling
                
                // Create the internal container
                const container = document.createElement('div');
                container.style.width = '100%';
                container.style.maxWidth = '500px';
                container.style.padding = '0';
                container.style.backgroundColor = 'transparent';
                container.style.borderRadius = '8px';
                overlay.appendChild(container);
                
                // Create header with title and done button
                const header = document.createElement('div');
                header.style.width = '100%';
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.marginBottom = '15px';
                container.appendChild(header);
                
                // Add title
                const title = document.createElement('div');
                title.textContent = isIOS ? 
                    'Tap and hold text, then select "Copy"' : 
                    'Select all and copy:';
                title.style.color = 'white';
                title.style.fontSize = '14px';
                title.style.flex = '1';
                header.appendChild(title);
                
                // Add done button
                const doneBtn = document.createElement('button');
                doneBtn.textContent = 'Done';
                doneBtn.style.padding = '8px 15px';
                doneBtn.style.backgroundColor = '#4CAF50';
                doneBtn.style.color = 'white';
                doneBtn.style.border = 'none';
                doneBtn.style.borderRadius = '5px';
                doneBtn.style.fontSize = '16px';
                doneBtn.style.marginLeft = '10px';
                doneBtn.style.cursor = 'pointer';
                header.appendChild(doneBtn);
                
                // Create text field
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.width = '100%';
                textarea.style.height = '120px';
                textarea.style.padding = '10px';
                textarea.style.backgroundColor = '#333';
                textarea.style.color = 'white';
                textarea.style.border = '1px solid #555';
                textarea.style.borderRadius = '5px';
                textarea.style.fontSize = '16px'; // Important for iOS
                container.appendChild(textarea);
                
                // Add overlay to page
                historySection.appendChild(overlay);
                
                // Focus and select text
                setTimeout(() => {
                    textarea.focus();
                    textarea.select();
                }, 100);
                
                // Define the close function
                function closeOverlay() {
                    if (historySection.contains(overlay)) {
                        historySection.removeChild(overlay);
                        isOverlayShown = false;
                    }
                }
                
                // Add done button listener - defined here to avoid multiple attachments
                doneBtn.onclick = function(e) {
                    e.preventDefault();
                    closeOverlay();
                };
                
                // Background click handler - use mousedown instead of click
                overlay.addEventListener('mousedown', function(e) {
                    if (e.target === overlay) {
                        closeOverlay();
                    }
                });
                
                // For touch devices
                overlay.addEventListener('touchstart', function(e) {
                    if (e.target === overlay) {
                        closeOverlay();
                    }
                });
                
                // Update button
                copyHistoryBtn.textContent = 'Copy Ready';
                setTimeout(() => {
                    if (!isOverlayShown) {
                        copyHistoryBtn.textContent = 'Copy';
                    }
                }, 2000);
            });
            
            // Handle touch events for copy button
            safeAddEventListener(copyHistoryBtn, 'touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Visual feedback
                const originalColor = copyHistoryBtn.style.backgroundColor;
                copyHistoryBtn.style.backgroundColor = '#555';
                copyHistoryBtn.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    copyHistoryBtn.style.backgroundColor = originalColor;
                    copyHistoryBtn.style.transform = 'scale(1)';
                    copyHistoryBtn.click();
                }, 100);
            }, { passive: false });
        });
    </script>
</body>
</html>